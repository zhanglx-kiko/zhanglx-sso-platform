server:
  port: 8080
  # 添加请求头缓冲区大小（避免大请求头报错）
  max-http-request-header-size: 16KB

spring:
  application:
    name: sso-gateway
  data:
    redis:
      host: 192.168.3.130
      port: 6379
      database: 0
      password: P@ssw0rd!23  # 替换为你的Redis密码（空密码则注释）
      timeout: 5000ms          # Redis连接超时
      # Lettuce客户端（Spring Boot默认，替代Jedis，支持异步/连接池）
      lettuce:
        pool:
          max-active: 50        # 最大连接数
          max-idle: 50          # 最大空闲连接
          min-idle: 5          # 最小空闲连接
          max-wait: 1000ms     # 连接等待超时
  cloud:
    # 负载均衡优化（避免服务调用超时）
    loadbalancer:
      # 重试配置
      retry:
        enabled: false                 # 开启负载均衡重试（非幂等接口（POST/DELETE）禁用，避免重复提交）
        maxRetriesOnNextServiceInstance: 1  # 切换服务实例重试次数（1次，最多试2个实例）
        maxRetriesOnSameServiceInstance: 0  # 同一实例重试次数（0，避免重复请求）
    gateway:
      server:
        webflux:
          httpclient:
            connect-timeout: 3000       # 网关与后端服务连接超时
            response-timeout: 10s         # 网关读取后端响应超时（4.2.7支持s/ms单位）
            pool:
              max-connections: 200        # 最大连接数（4.2.7新增，控制连接池大小）
          routes:
            # 认证服务路由配置
            - id: sso-auth-route
              order: 1  # 路由优先级（数字越小越优先）
              # lb:// 代表负载均衡转发到 sso-auth 服务
              # IP地址代表直连，不需要负载均衡中间件如Nacos、Eureka
              uri: http://localhost:9000
              predicates:
                - Path=/auth/**
                - Method=GET,POST,DELETE,PUT  # 限定HTTP方法，提升匹配效率
              filters:
                # 保留原始响应体，不进行封装
                - PreserveHostHeader
                # 设置超时时间
                - name: RequestRateLimiter
                  args:
                    redis-rate-limiter.replenishRate: 10
                    redis-rate-limiter burstCapacity: 20
                    key-resolver: "#{@ipKeyResolver}"  # 按IP限流（需自定义Bean）
          # 全局过滤器配置,仅对GET请求配置重试，避免非幂等请求重复提交
          default-filters:
            - name: Retry
              args:
                retries: 1
                methods: GET  # 仅重试GET请求
                series: SERVER_ERROR
                statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE,GATEWAY_TIMEOUT
          # ========== 跨域配置（4.2.7统一在网关层处理，避免服务重复配置） ==========
          globalcors:
            cors-configurations:
              '[/**]':
                allowed-origins:
                  - "http://localhost:8080"
                  - "http://localhost:9000"
                  - "http://localhost:5173"
                allowed-methods: "*"        # 允许所有HTTP方法
                allowed-headers: "*"        # 允许所有请求头
                allow-credentials: true    # 允许携带Cookie
                max-age: 3600             # 预检请求缓存时间（4.2.7支持s单位）
  web:
    error:
      include-message: always # 错误响应中包含消息（生产建议设never，避免泄露敏感信息）
      include-binding-errors: always # 包含参数绑定错误（同上，生产需关闭）
  # 全局启用虚拟线程支持（Spring Boot4.0+ 核心配置）
  threads:
    virtual:
      enabled: true

# Sa-Token 配置 (必须与 sso-auth 保持一致，否则无法解析 Token)
sa-token:
  token-name: token
  timeout: 7200    # Token有效期2小时（秒）
  active-timeout: 1800    # 无操作自动续期30分钟（秒）
  is-concurrent: true
  is-share: false
  token-style: jwt
  is-read-cookie: true
  is-read-header: true
  # 网关特有配置：全局过滤器
  check-same-token: false # 是否开启 Same-Token 同源检测


# ========== 日志配置（配合全局日志过滤器，4.2.7版本兼容） ==========
logging:
  level:
    root: info
    org.springframework.cloud.gateway: info  # 网关核心日志（排查问题时开启）
    com.zhanglx.sso.gateway.filter: info    # 自定义日志过滤器
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n"
  file:
    name: logs/sso-gateway.log
  logback:
    rollingpolicy:
      max-file-size: 100MB
      max-history: 7
      total-size-cap: 1GB  # 日志总大小限制，避免磁盘占满


